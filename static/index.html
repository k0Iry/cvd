<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <title>CVD (Axum)</title>
    <style>
        body {
            margin: 0;
            background: #111;
            color: #ddd;
            font-family: sans-serif;
        }

        .bar {
            padding: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid #222;
        }

        #wrap {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 46px);
        }

        #price {
            flex: 2;
        }

        #cvd {
            flex: 1;
            border-top: 1px solid #333;
        }

        select {
            background: #222;
            color: #ddd;
            border: 1px solid #444;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .pill {
            font-size: 12px;
            padding: 2px 8px;
            border: 1px solid #333;
            border-radius: 999px;
        }
    </style>
</head>

<body>
    <div class="bar">
        <div class="pill">Source: local axum</div>

        <div>Market:</div>
        <select id="market">
            <option value="spot">spot</option>
            <option value="usdm">usdm</option>
            <option value="coinm">coinm</option>
        </select>

        <div>TF:</div>
        <select id="tf">
            <option value="1m">1m</option>
            <option value="5m">5m</option>
        </select>

        <div id="status" class="pill">loading…</div>
    </div>

    <div id="wrap">
        <div id="price"></div>
        <div id="cvd"></div>
    </div>

    <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
    <script>
        const marketSel = document.getElementById("market");
        const tfSel = document.getElementById("tf");
        const statusEl = document.getElementById("status");
        const priceEl = document.getElementById("price");
        const cvdEl = document.getElementById("cvd");

        function mkChart(el) {
            return LightweightCharts.createChart(el, {
                layout: { background: { color: "#111" }, textColor: "#ddd" },
                grid: { vertLines: { color: "#222" }, horzLines: { color: "#222" } },
                timeScale: {
                    borderColor: "#333",
                    timeVisible: true,
                    secondsVisible: false,
                    rightOffset: 2,
                },
                rightPriceScale: { borderColor: "#333" },
                crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                width: el.clientWidth,
                height: el.clientHeight,
                // 允许滚轮/拖动缩放（横向）
                handleScroll: { mouseWheel: true, pressedMouseMove: true, horzTouchDrag: true, vertTouchDrag: true },
                handleScale: { mouseWheel: true, pinch: true, axisPressedMouseMove: true },
            });
        }

        // 上：价格；下：CVD
        const priceChart = mkChart(priceEl);
        const cvdChart = mkChart(cvdEl);

        // Price 线（右轴）
        const priceSeries = priceChart.addLineSeries({
            lineWidth: 2,
            color: "#f2c94c",
            lastValueVisible: true,
            priceLineVisible: true,
        });

        // CVD 线（右轴即可；你要左轴也可以，但一般下面 pane 用右轴更直观）
        const cvdSeries = cvdChart.addLineSeries({
            lineWidth: 2,
            color: "#56ccf2",
            priceFormat: {
                type: "custom",
                formatter: (p) => {
                    const abs = Math.abs(p);
                    if (abs >= 1e9) return (p / 1e9).toFixed(2) + "B";
                    if (abs >= 1e6) return (p / 1e6).toFixed(2) + "M";
                    if (abs >= 1e3) return (p / 1e3).toFixed(2) + "K";
                    return p.toFixed(0);
                },
            },
        });

        // 让下方 CVD 的右轴文字颜色和线一致
        cvdChart.priceScale("right").applyOptions({ textColor: "#56ccf2", borderColor: "#333" });
        priceChart.priceScale("right").applyOptions({ textColor: "#f2c94c", borderColor: "#333" });

        // resize
        function resize() {
            priceChart.applyOptions({ width: priceEl.clientWidth, height: priceEl.clientHeight });
            cvdChart.applyOptions({ width: cvdEl.clientWidth, height: cvdEl.clientHeight });
        }
        window.addEventListener("resize", resize);

        // ---------------------------
        // ✅ timeScale 同步（核心）
        // ---------------------------
        let syncing = false;

        function syncTimeScale(fromChart, toChart) {
            fromChart.timeScale().subscribeVisibleLogicalRangeChange((range) => {
                if (!range) return;
                if (syncing) return;
                syncing = true;
                toChart.timeScale().setVisibleLogicalRange(range);
                syncing = false;
            });
        }

        syncTimeScale(priceChart, cvdChart);
        syncTimeScale(cvdChart, priceChart);

        // ---------------------------
        // ✅ crosshair 同步（可选但非常爽）
        // ---------------------------
        function getSeriesPrice(param, series) {
            const sp = param && param.seriesPrices;
            if (!sp) return null;

            // Map-like
            if (typeof sp.get === "function") {
                const v = sp.get(series);
                return typeof v === "number" ? v : null;
            }

            // Object-like (rare, but guard anyway)
            try {
                const v = sp[series];
                return typeof v === "number" ? v : null;
            } catch {
                return null;
            }
        }

        function syncCrosshair(srcChart, dstChart, srcSeries, dstSeries) {
            srcChart.subscribeCrosshairMove((param) => {
                if (!param || param.time === undefined) {
                    dstChart.clearCrosshairPosition();
                    return;
                }

                const price = getSeriesPrice(param, srcSeries);

                // ✅ 不要 setCrosshairPosition(0, ...) —— 0 可能导致奇怪的 scale 行为
                if (price == null) {
                    dstChart.setCrosshairPosition(NaN, param.time, dstSeries);
                } else {
                    dstChart.setCrosshairPosition(price, param.time, dstSeries);
                }
            });
        }

        syncCrosshair(priceChart, cvdChart, priceSeries, cvdSeries);
        syncCrosshair(cvdChart, priceChart, cvdSeries, priceSeries);

        // ---------------------------
        // 数据加载与 WS
        // ---------------------------
        let ws;

        async function loadHistory(market, tf) {
            statusEl.textContent = "loading…";
            const res = await fetch(`/history?market=${market}&tf=${tf}&limit=800`);
            const bars = await res.json();

            priceSeries.setData(bars.map(b => ({ time: b.time, value: b.price_close })));
            cvdSeries.setData(bars.map(b => ({ time: b.time, value: b.cvd_usdt })));

            // 两张图都滚到最新（因为 timeScale 同步，滚一个也行）
            priceChart.timeScale().scrollToRealTime();
            statusEl.textContent = "live";
        }

        function connectWs(market, tf) {
            if (ws) ws.close();
            const proto = location.protocol === "https:" ? "wss" : "ws";
            ws = new WebSocket(`${proto}://${location.host}/ws?market=${market}&tf=${tf}`);

            ws.onopen = () => statusEl.textContent = "live";
            ws.onclose = () => statusEl.textContent = "disconnected";
            ws.onerror = () => statusEl.textContent = "error";

            ws.onmessage = (ev) => {
                const b = JSON.parse(ev.data);
                // 更新两张图（time 一样就会对齐）
                priceSeries.update({ time: b.time, value: b.price_close });
                cvdSeries.update({ time: b.time, value: b.cvd_usdt });
            };
        }

        async function reload() {
            const market = marketSel.value;
            const tf = tfSel.value;
            await loadHistory(market, tf);
            connectWs(market, tf);
        }

        marketSel.addEventListener("change", reload);
        tfSel.addEventListener("change", reload);

        reload();
    </script>
</body>

</html>